
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
  <HEAD>
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/space.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/master.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/wiki-content.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/abs.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/menu.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/menu-ie.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/tables.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/panels.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/master-ie.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/renderer-macros.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/content-types.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/login.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/information-macros.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/layout-macros.css">
<LINK type="text/css" rel="stylesheet" href="https://cwiki.apache.org/confluence/display/MAHOUT/$stylebase/default-theme.css">
    <LINK type="text/css" rel="stylesheet" href="resources/space.css">
    <STYLE type="text/css">
      .footer {
        background-image:      url('https://cwiki.apache.org/confluence/images/border/border_bottom.gif');
        background-repeat:     repeat-x;
        background-position:   left top;
        padding-top:           4px;
        color:                 #666;
      }
    </STYLE>
    <SCRIPT type="text/javascript" language="javascript">
      var hide = null;
      var show = null;
      var children = null;

      function init() {
        /* Search form initialization */
        var form = document.forms['search'];
        if (form != null) {
          form.elements['domains'].value = location.hostname;
          form.elements['sitesearch'].value = location.hostname;
        }

        /* Children initialization */
        hide = document.getElementById('hide');
        show = document.getElementById('show');
        children = document.all != null ?
                   document.all['children'] :
                   document.getElementById('children');
        if (children != null) {
          children.style.display = 'none';
          show.style.display = 'inline';
          hide.style.display = 'none';
        }
      }

      function showChildren() {
        children.style.display = 'block';
        show.style.display = 'none';
        hide.style.display = 'inline';
      }

      function hideChildren() {
        children.style.display = 'none';
        show.style.display = 'inline';
        hide.style.display = 'none';
      }
    </SCRIPT>
    <TITLE>K-Means Clustering</TITLE>
  <META http-equiv="Content-Type" content="text/html;charset=UTF-8"></HEAD>
  <BODY onload="init()">
    <TABLE border="0" cellpadding="2" cellspacing="0" width="100%">
      <TR class="topBar">
        <TD align="left" valign="middle" class="topBarDiv" align="left" nowrap="">
          &nbsp;<A href="mahout-wiki.html" title="Apache Mahout">Apache Mahout</A>&nbsp;&gt;&nbsp;<A href="mahout-wiki.html" title="Mahout Wiki">Mahout Wiki</A>&nbsp;&gt;&nbsp;<A href="algorithms.html" title="Algorithms">Algorithms</A>&nbsp;&gt;&nbsp;<A href="" title="K-Means Clustering">K-Means Clustering</A>
        </TD>
        <TD align="right" valign="middle" nowrap="">
          <FORM name="search" action="http://www.google.com/search" method="get">
            <INPUT type="hidden" name="ie" value="UTF-8">
            <INPUT type="hidden" name="oe" value="UTF-8">
            <INPUT type="hidden" name="domains" value="">
            <INPUT type="hidden" name="sitesearch" value="">
            <INPUT type="text" name="q" maxlength="255" value="">        
            <INPUT type="submit" name="btnG" value="Google Search">
          </FORM>
        </TD>
      </TR> 
    </TABLE>

    <DIV id="PageContent">
      <DIV class="pageheader" style="padding: 6px 0px 0px 0px;">
        <!-- We'll enable this once we figure out how to access (and save) the logo resource -->
        <!--img src="/wiki/images/confluence_logo.gif" style="float: left; margin: 4px 4px 4px 10px;" border="0"-->
        <DIV style="margin: 0px 10px 0px 10px" class="smalltext">Apache Mahout</DIV>
        <DIV style="margin: 0px 10px 8px 10px" class="pagetitle">K-Means Clustering</DIV>

        <DIV class="greynavbar" align="right" style="padding: 2px 10px; margin: 0px;">
          <A href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=75159">
            <IMG src="https://cwiki.apache.org/confluence/images/icons/notep_16.gif" height="16" width="16" border="0" align="absmiddle" title="Edit Page"></A>
            <A href="https://cwiki.apache.org/confluence/pages/editpage.action?pageId=75159">Edit Page</A>
          &nbsp;
          <A href="https://cwiki.apache.org/confluence/pages/listpages.action?key=MAHOUT">
            <IMG src="https://cwiki.apache.org/confluence/images/icons/browse_space.gif" height="16" width="16" border="0" align="absmiddle" title="Browse Space"></A>
            <A href="https://cwiki.apache.org/confluence/pages/listpages.action?key=MAHOUT">Browse Space</A>
          &nbsp;
          <A href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=MAHOUT&fromPageId=75159">
            <IMG src="https://cwiki.apache.org/confluence/images/icons/add_page_16.gif" height="16" width="16" border="0" align="absmiddle" title="Add Page"></A>
          <A href="https://cwiki.apache.org/confluence/pages/createpage.action?spaceKey=MAHOUT&fromPageId=75159">Add Page</A>
          &nbsp;
          <A href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=MAHOUT&fromPageId=75159">
            <IMG src="https://cwiki.apache.org/confluence/images/icons/add_blogentry_16.gif" height="16" width="16" border="0" align="absmiddle" title="Add News"></A>
          <A href="https://cwiki.apache.org/confluence/pages/createblogpost.action?spaceKey=MAHOUT&fromPageId=75159">Add News</A>
        </DIV>
      </DIV>

      <DIV class="pagecontent">
        <DIV class="wiki-content">
          <P>k-Means is a rather <FONT color="#ff0000">simple</FONT> but well known algorithms for grouping objects, clustering. Again all objects need to be represented as a set of numerical features. In addition the user has to specify the number of groups (referred to as <EM>k</EM>) he wishes to identify.<BR>
Each object can be thought of as being represented by some feature vector in an <EM>n</EM> dimensional space, <EM>n</EM> being the number of all features used to describe the objects to cluster. The algorithm then randomly chooses <EM>k</EM> points in that vector space, these point serve as the initial centers of the clusters. Afterwards all objects are each assigned to center they are closest to. Usually the distance measure is chosen by the user and determined by the learning task.<BR>
After that, for each cluster a new center is computed by averaging the feature vectors of all objects assigned to it. The process of assigning objects and recomputing centers is repeated until the process converges. The algorithm can be proven to converge after a finite number of iterations.<BR>
Several tweaks concerning distance measure, initial center choice and computation of new average centers have been explored, as well as the estimation of the number of clusters <EM>k</EM>. Yet the main principle always remains the same.</P>



<H2><A name="K-MeansClustering-Quickstart"></A>Quickstart</H2>

<P><A href="k-means-clustering.data/quickstart-kmeans.sh">Here</A> is a short shell script outline that will get you started quickly with k-Means. This does the following:</P>

<UL>
	<LI>Get the Reuters dataset</LI>
	<LI>Run org.apache.lucene.benchmark.utils.ExtractReuters to generate reuters-out from reuters-sgm(the downloaded archive)</LI>
	<LI>Run seqdirectory to convert reuters-out to SequenceFile format</LI>
	<LI>Run seq2sparse to convert SequenceFiles to sparse vector format</LI>
	<LI>Finally, run kMeans with 20 clusters.</LI>
</UL>


<P>After following through the output that scrolls past, reading the code will offer you a better understanding.</P>


<H2><A name="K-MeansClustering-Strategyforparallelization"></A>Strategy for parallelization</H2>

<P>Some ideas can be found in <A href="http://code.google.com/edu/content/submissions/mapreduce-minilecture/listing.html" class="external-link" rel="nofollow">Cluster computing and MapReduce</A> lecture video series [by Google(r)]; k-Means clustering is discussed in <A href="http://www.youtube.com/watch?v=1ZDybXl212Q" class="external-link" rel="nofollow">lecture #4</A>. Slides can be found <A href="http://code.google.com/edu/content/submissions/mapreduce-minilecture/lec4-clustering.ppt" class="external-link" rel="nofollow">here</A>.</P>

<P>Interestingly, Hadoop based implementation using <A href="http://en.wikipedia.org/wiki/Canopy_clustering_algorithm" class="external-link" rel="nofollow">Canopy-clustering</A> seems to be here: <A href="http://code.google.com/p/canopy-clustering/" class="external-link" rel="nofollow">http://code.google.com/p/canopy-clustering/</A> (GPL 3 licence)</P>

<P>Here's another useful paper <A href="http://www2.chass.ncsu.edu/garson/PA765/cluster.htm" class="external-link" rel="nofollow">http://www2.chass.ncsu.edu/garson/PA765/cluster.htm</A>.</P>

<H2><A name="K-MeansClustering-Designofimplementation"></A>Design of implementation</H2>

<P>The implementation accepts two input directories: one for the data points and one for the initial clusters. The data directory contains multiple input files of SequenceFile(key, VectorWritable), while the clusters directory contains one or more SequenceFiles(Text, Cluster &#124; Canopy) containing <EM>k</EM> initial clusters or canopies. None of the input directories are modified by the implementation, allowing experimentation with initial clustering and convergence values.</P>

<P>The program iterates over the input points and clusters, outputting a new directory &quot;clusters-N&quot; containing SequenceFile(Text, Cluster) files for each iteration N. This process uses a mapper/combiner/reducer/driver as follows:</P>
<UL>
	<LI>KMeansMapper - reads the input clusters during its setup() method, then assigns and outputs each input point to its nearest cluster as defined by the user-supplied distance measure. Output key is: cluster identifier. Output value is: ClusterObservation.</LI>
	<LI>KMeansCombiner - receives all key:value pairs from the mapper and produces partial sums of the input vectors for each cluster. Output key is: cluster identifier. Output value is ClusterObservation.</LI>
	<LI>KMeansReducer - a single reducer receives all key:value pairs from all combiners and sums them to produce a new centroid for the cluster which is output. Output key is: encoded cluster identifier. Output value is: Cluster. The reducer encodes unconverged clusters with a 'Cn' cluster Id and converged clusters with 'Vn' clusterId.</LI>
	<LI>KMeansDriver - iterates over the points and clusters until all output clusters have converged (Vn clusterIds) or until a maximum number of iterations has been reached. During iterations, a new clusters directory &quot;clusters-N&quot; is produced with the output clusters from the previous iteration used for input to the next. A final optional pass over the data using the KMeansClusterMapper clusters all points to an output directory &quot;clusteredPoints&quot; and has no combiner or reducer steps.</LI>
</UL>


<P>Canopy clustering can be used to compute the initial clusters for k-KMeans:</P>
<BLOCKQUOTE>
<P>// run the CanopyDriver job<BR>
CanopyDriver.runJob(&quot;testdata&quot;, &quot;output&quot; ManhattanDistanceMeasure.class.getName(), (float) 3.1, (float) 2.1, false);</P>

<P>// now run the KMeansDriver job<BR>
KMeansDriver.runJob(&quot;testdata&quot;, &quot;output/clusters-0&quot;, &quot;output&quot;, EuclideanDistanceMeasure.class.getName(), &quot;0.001&quot;, &quot;10&quot;, true);</P></BLOCKQUOTE>

<P>In the above example, the input data points are stored in 'testdata' and the CanopyDriver is configured to output to the 'output/clusters-0' directory. Once the driver executes it will contain the canopy definition files. Upon running the KMeansDriver the output directory will have two or more new directories: 'clusters-N'' containining the clusters for each iteration and 'clusteredPoints' will contain the clustered data points.</P>

<P>This diagram shows the examplary dataflow of the k-Means example implementation provided by Mahout:</P>


<MAP name="GLIFFY_MAP_75159_Example_implementation_of_k-Means_provided_with_Mahout"></MAP>
<TABLE width="100%">
    <TR>
        <TD align="left">
            <TABLE>
                <CAPTION align="bottom">
                    
                        
                        <A href="https://cwiki.apache.org/confluence/plugins/gliffy/viewlargediagram.action?name=Example%20implementation%20of%20k-Means%20provided%20with%20Mahout&ceoid=75159&key=MAHOUT&pageId=75159" target="">Full Size</A>
                    
                         | 
                        <A href="https://cwiki.apache.org/confluence/plugins/gliffy/showgliffyeditor.action?name=Example%20implementation%20of%20k-Means%20provided%20with%20Mahout&ceoid=75159&key=MAHOUT&lastPage=%2Fdisplay%2FMAHOUT%2FK-Means%20Clustering&pageId=75159" target="">Edit Diagram</A>
                                    </CAPTION>
                <TR>
                    <TD>
                        <IMG style="border: none; width: 822px; height: 816px;" usemap="#GLIFFY_MAP_75159_Example_implementation_of_k-Means_provided_with_Mahout" src="k-means-clustering.data/Example%20implementation%20of%20k-Means%20provided%20with%20Mahout.png" alt="A&#32;Gliffy&#32;Diagram&#32;named&#58;&#32;Example&#32;implementation&#32;of&#32;k&#45;Means&#32;provided&#32;with&#32;Mahout">
                    </TD>
                </TR>
            </TABLE>
        </TD>
    </TR>
</TABLE>




<P>This diagram doesn't consider CanopyClustering:</P>

<TABLE style="background-color: #2C8FCF;  height: 38px">
    <TR>
        <TD style="vertical-align: middle; padding-top: 0px; padding-bottom: 0px;">
            <DIV style="padding: 3px"><IMG src="https://cwiki.apache.org/confluence/download/resources/com.gliffy.integration.confluence:gliffy-macro-key/resources/icons/gliffylogo32x32.PNG">
            </DIV>
        </TD>
        <TD style="border-right: 2px solid white; padding:3px">
            <SPAN style="font-size:120%; font-weight: bold; color: white">Macro Error</SPAN>
        </TD>
        <TD style="padding: 3px;">
            <SPAN style="color:white;">
                Cannot find the diagram with these parameters: <BR>
                <STRONG>name:</STRONG> k-Means Example <BR>
                <STRONG>version:</STRONG>  <BR>
                <STRONG>pageName:</STRONG> k-Means <BR>
                <STRONG>pageId:</STRONG>  <BR>
                <STRONG>spaceKey:</STRONG> MAHOUT <BR>
            </SPAN>

                    </TD>
    </TR>
</TABLE>


<H2><A name="K-MeansClustering-RunningkMeansClustering"></A>Running k-Means Clustering</H2>

<P>The k-Means clustering algorithm may be run using a command-line invocation on KMeansDriver.main or by making a Java call to KMeansDriver.runJob().</P>

<P>Invocation using the command line takes the form:</P>

<DIV class="preformatted panel" style="border-width: 1px;"><DIV class="preformattedContent panelContent">
<PRE>bin/mahout kmeans \
    -i &lt;input vectors directory&gt; \
    -c &lt;input clusters directory&gt; \
    -o &lt;output working directory&gt; \
    -k &lt;optional number of initial clusters to sample from input vectors&gt; \
    -dm &lt;DistanceMeasure&gt; \
    -x &lt;maximum number of iterations&gt; \
    -cd &lt;optional convergence delta. Default is 0.5&gt; \
    -ow &lt;overwrite output directory if present&gt;
    -cl &lt;run input vector clustering after computing Canopies&gt;
    -xm &lt;execution method: sequential or mapreduce&gt;
</PRE>
</DIV></DIV>

<P>Note: if the &#45;k argument is supplied, any clusters in the &#45;c directory will be overwritten and &#45;k random points will be sampled from the input vectors to become the initial cluster centers.</P>

<P>Invocation using Java involves supplying the following arguments:</P>

<OL>
	<LI>input: a file path string to a directory containing the input data set a SequenceFile(WritableComparable, VectorWritable). The sequence file <EM>key</EM> is not used.</LI>
	<LI>clusters: a file path string to a directory containing the initial clusters, a SequenceFile(key, Cluster &#124; Canopy). Both KMeans clusters and Canopy canopies may be used for the initial clusters.</LI>
	<LI>output: a file path string to an empty directory which is used for all output from the algorithm.</LI>
	<LI>distanceMeasure: the fully-qualified class name of an instance of DistanceMeasure which will be used for the clustering.</LI>
	<LI>convergenceDelta: a double value used to determine if the algorithm has converged (clusters have not moved more than the value in the last iteration)</LI>
	<LI>maxIter: the maximum number of iterations to run, independent of the convergence specified</LI>
	<LI>runClustering: a boolean indicating, if true, that the clustering step is to be executed after clusters have been determined.</LI>
	<LI>runSequential: a boolean indicating, if true, that the k-means sequential implementation is to be used to process the input data.</LI>
</OL>


<P>After running the algorithm, the output directory will contain:</P>
<OL>
	<LI>clusters-N: directories containing SequenceFiles(Text, Cluster) produced by the algorithm for each iteration. The Text <EM>key</EM> is a cluster identifier string.</LI>
	<LI>clusteredPoints: (if &#45;-clustering enabled) a directory containing SequenceFile(IntWritable, WeightedVectorWritable). The IntWritable <EM>key</EM> is the clusterId. The WeightedVectorWritable <EM>value</EM> is a bean containing a double <EM>weight</EM> and a VectorWritable <EM>vector</EM> where the weight indicates the probability that the vector is a member of the cluster. For k-Means clustering, the weights are computed as 1/(1+distance) where the distance is between the cluster center and the vector using the chosen DistanceMeasure.</LI>
</OL>


<H1><A name="K-MeansClustering-Examples"></A>Examples</H1>

<P>The following images illustrate k-Means clustering applied to a set of randomly-generated 2-d data points. The points are generated using a normal distribution centered at a mean location and with a constant standard deviation. See the README file in the <A href="http://svn.apache.org/repos/asf/mahout/trunk/examples/src/main/java/org/apache/mahout/clustering/display/README.txt" class="external-link" rel="nofollow">/examples/src/main/java/org/apache/mahout/clustering/display/README.txt</A> for details on running similar examples.</P>

<P>The points are generated as follows:</P>

<UL>
	<LI>500 samples m=[1.0, 1.0] sd=3.0</LI>
	<LI>300 samples m=[1.0, 0.0] sd=0.5</LI>
	<LI>300 samples m=[0.0, 2.0] sd=0.1</LI>
</UL>


<P>In the first image, the points are plotted and the 3-sigma boundaries of their generator are superimposed.</P>

<P><SPAN class="image-wrap" style=""><IMG src="k-means-clustering.data/SampleData.png" style="border: 0px solid black"></SPAN></P>

<P>In the second image, the resulting clusters (k=3) are shown superimposed upon the sample data. As k-Means is an iterative algorithm, the centers of the clusters in each recent iteration are shown using different colors. Bold red is the final clustering and previous iterations are shown in [orange, yellow, green, blue, violet and gray]. Although it misses a lot of the points and cannot capture the original, superimposed cluster centers, it does a decent job of clustering this data.</P>

<P><SPAN class="image-wrap" style=""><IMG src="k-means-clustering.data/KMeans.png" style="border: 0px solid black"></SPAN></P>

<P>The third image shows the results of running k-Means on a different data set (see <A href="dirichlet-process-clustering.html" title="Dirichlet Process Clustering">Dirichlet Process Clustering</A> for details) which is generated using asymmetrical standard deviations. K-Means does a fair job handling this data set as well.</P>

<P><SPAN class="image-wrap" style=""><IMG src="k-means-clustering.data/2dKMeans.png" style="border: 0px solid black"></SPAN></P>
        </DIV>

        
      </DIV>
    </DIV>
    <DIV class="footer">
      Generated by
      <A href="http://www.atlassian.com/confluence/">Atlassian Confluence</A> (Version: 3.4.9 Build: 2042 Feb 14, 2011)
      <A href="http://could.it/autoexport/">Auto Export Plugin</A> (Version: 1.0.0-dkulp)
    </DIV>
<SCRIPT type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-17359171-1']);
  _gaq.push(['_setDomainName', 'none']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</SCRIPT>
  </BODY>
</HTML>